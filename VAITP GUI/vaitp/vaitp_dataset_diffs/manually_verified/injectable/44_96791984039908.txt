def _join_and_check_path_within_fs(fs, *args):
    absolute_path = os.path.realpath(os.path.join(fs, *args))
    if not absolute_path.startswith(os.path.realpath(fs) + '/'):
        raise exception.Invalid(_('injected file path not valid'))
    return absolute_path
    
def _inject_file_into_fs(fs, path, contents, append=False):
    absolute_path = _join_and_check_path_within_fs(fs, path.lstrip('/'))
    args = []
    if append:
        args.append('-a')
        args.append(absolute_path)
        kwargs = dict(process_input=contents, run_as_root=True)
        utils.execute('tee', *args, **kwargs)
        _inject_file_into_fs(fs, 'meta.js', jsonutils.dumps(metadata))
        sshdir = _join_and_check_path_within_fs(fs, 'root', '.ssh')
        keyfile = os.path.join('root', '.ssh', 'authorized_keys')
        key_data = ''.join([
        ])
        _inject_file_into_fs(fs, keyfile, key_data, append=True)
        netdir = _join_and_check_path_within_fs(fs, 'etc', 'network')
        netfile = os.path.join('etc', 'network', 'interfaces')
        _inject_file_into_fs(fs, netfile, net)
        passwd_path = _join_and_check_path_within_fs(fs, 'etc', 'passwd')
        shadow_path = _join_and_check_path_within_fs(fs, 'etc', 'shadow')
        utils.execute('cp', passwd_path, tmp_passwd, run_as_root=True)
        utils.execute('cp', shadow_path, tmp_shadow, run_as_root=True)
        utils.execute('cp', tmp_passwd, passwd_path, run_as_root=True)
        utils.execute('cp', tmp_shadow, shadow_path, run_as_root=True)
