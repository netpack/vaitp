# VAITP Info Agent (based on Blackbox.ai)
# Assumes that the MySQL environment variables are correctly set
# Assumes that the BlackBox.ai API server is running on localhost:3000
# https://github.com/notsopreety/blackbox-api.git

import mysql.connector, os, requests, time, random

# Define time delay between requests
min = 5
max = 30

# Define the URL and parameters
url = "http://localhost:3000/api/blackbox"

def remove_first_and_last_line_if_match(text, first_match_string="```python", last_match_string="```"):
    # Split the text into lines
    lines = text.splitlines()

    # Check if the first line matches the specified first match string
    if lines and lines[0] == first_match_string:
        lines = lines[1:]  # Remove the first line

    # Check if the last line matches the specified last match string
    if lines and lines[-1] == last_match_string:
        lines = lines[:-1]  # Remove the last line

    # Join the remaining lines back into a single string
    return "\n".join(lines)

cnx = mysql.connector.connect(
    user=os.getenv('MYSQL_USER'),
    password=os.getenv('MYSQL_PASSWORD'),
    host=os.getenv('MYSQL_HOST'),
    database=os.getenv('MYSQL_DATABASE')
)
# Create a cursor object
cursor = cnx.cursor()
# Execute a SQL query to retrieve each row of 'python_vulnerabilities' table
cursor.execute("SELECT * FROM python_vulnerabilities ORDER BY `python_vulnerabilities`.`ID` DESC")
# Fetch all rows from the last executed statement
rows = cursor.fetchall()

# Close the cursor and connection
cursor.close
cnx.close

# Process each row
n=0
for row in rows:
    n=n+1
    delay = random.randint(min, max)
    cve = row[17]
    print(f'Reviewing vulnerability {cve}. Request delay set to {delay} seconds.')
    fullDescription = row[4]
    id = row[0]
    odc = row[1]
    cdc = row[2]
    vulnerabilityShortDescription = row[3]
    Score = row[6]
    cwe = row[8]
    owasp = row[10]
    acessibilityScope = row[11]
    category = row[12]
    subcategory = row[13]
    impact = row[14]
    solution = row[15]
    changeIn = row[16]
    fixedbyupgrading = row[18]
    patchedcodesample = row[19]
    vulnerablecodesample = row[20]
    payloadneeded = row[21]
    payload = row[22]
    isPython = row[25]
    if odc is None:
        print(f'Vulnerability {cve} is missing ODC!')
        odcQueryString = f"Orthogonal Defect Classification categories: 'Function, Interface, Checking, Assignment, Timing/Serialization, Build/Package/Merge, Algorithm' ; Based on the provided Orthogonal Defect Classification categories, propose the Orthogonal Defects Classification category that best fits for the following vulnerability description: '{fullDescription}'. Reson if the category is the best fitting and reconsider if necessary. Only inlcude in the answer the best fitting category itself and nothing else."
        params = {
            "text": odcQueryString,
            "conversationId": n
        }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose ODC")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set OrthogonalDefectClassification column to response_value where cve = cve
                query = "UPDATE python_vulnerabilities SET OrthogonalDefectClassification = %s WHERE CVE = %s"
                cursor.execute(query, (odc, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with ODC {odc}")
                cursor.close
                cnx.close
            
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if cdc is None:
        print(f'Vulnerability {cve} is missing CDC!')
        cdcQueryString = f"Code Defect Classification categories: 'Missing Functionality,Incorrect Functionality,Extraneous Functionality,Missing Interface,Incorrect Interface,Extraneous Interface,Missing Check,Incorrect Check,Extraneous Check,Missing Assignment,Incorrect Assignment,Extraneous Assignment,Timing Issues,Serialization Issues,Extraneous Serialization,Building Issues,Packaging Issues,Merging Conflicts,Missing Algorithm,Incorrect Algorithm,Extraneous Algorithm' ; Based on the provided Code Defect Classification categories, propose the Coode Defects Classification category that best fits for the following vulnerability description: '{fullDescription}'. Note that we selected '{odc}' as the Orthogonal Defect Classification, so this Code Defect Classification should be coherent. Reson if the category is the best fitting and reconsider if necessary. Only inlcude in the answer the best fitting category itself and nothing else."
        params = {
            "text": cdcQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose a CDC")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set CodeDefectClassification column to response_value where cve = cve
                query = "UPDATE python_vulnerabilities SET CodeDefectClassification = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with CDC {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if vulnerabilityShortDescription is None:
        print(f'Vulnerability {cve} is missing Short Description!')
        shortDescriptionQueryString = f"Provide a short description (aproximatly 75 chars) for the following vulnerability full description: '{fullDescription}'. Only include in your answer the short description of the vulnerability and nothing else."
        params = {
            "text": shortDescriptionQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not proposed a short description")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set VulnerabilityShortDescription column to response_value where cve = cve
                query = "UPDATE python_vulnerabilities SET VulnerabilityShortDescription = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with Short Description {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if Score == "0.0" or Score is None:
        print(f'Vulnerability {cve} is missing Score')
        scoreQueryString = f"Provide a good fitting score (between 1-10) for the following vulnerability description: '{fullDescription}'. Include only the score in your answer and nothing else."
        params = {
            "text": scoreQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose a score")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set Score column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET Score = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with Score {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
            print("Delaying next request...")
            time.sleep(delay)
    if cwe is None:
        print(f'Vulnerability {cve} is missing CWE')
        cweQueryString = f"Provide the best fitting CWE for the following vulnerability description: '{fullDescription}'. Include in your answer only the best fitting CWE number and nothing else."
        params = {
            "text": cweQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose CWE")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set CWE column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET CWE = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with CWE {response_value}")
                # Update 'python_vulnerability' table set CWELink to a link to the corresponding CWE definition
                query = "UPDATE python_vulnerabilities SET CWELink = %s WHERE CVE = %s"
                cwelink = f"https://cwe.mitre.org/data/definitions/{response_value}"
                cursor.execute(query, (cwelink, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with CWE Link {cwelink}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if owasp is None:
        print(f'Vulnerability {cve} is missing OWASP')
        owaspQueryString = f"Provide the best fitting OWASP category for the following vulnerability description: '{fullDescription}'. Only include in your answer the OWASP category in the format Axx Name (e.g.: A08 Software and Data Integrity Failures) and nothing else."
        params = {
            "text": owaspQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose OWASP")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set CWE column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET OWASP = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with OWASP {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if acessibilityScope is None:
        print(f'Vulnerability {cve} is missing Acessibility Scope')
        acessibilityQueryString = f"Provide the best fitting Acessibility Scope (i.e.: 'Local' [if the vulnerability can only be exploited having local access to the system] or 'Remote' [if the vulnerability can be exploited from the network]) for the following vulnerability description: '{fullDescription}'. Include only the Accessibility Scope 'Local' or 'Remote' in your anwser accordingly, and nothing else."
        params = {
            "text": acessibilityQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose VAITP Acessibility Scope")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set AccesibiltyScope column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET AccessibilityScope = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with AccessibilityScope {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if category is None:
        print(f'Vulnerability {cve} is missing Category')
        categoryQueryString = f"Provide the best fitting VAITP Category from the following list: 'Input Validation and Sanitization,\"Authentication, Authorization, and Session Management\",Cryptographic,Design Defects,Configuration Issues,Memory Corruption,Information Leakage,Race Conditions,Resource Management,Numeric Errors' that could represent the following vulnerability description: '{fullDescription}'. Include in your answer only the VAITP Category that best fits the vulnerability and nothing else."
        params = {
            "text": categoryQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose a VAITP category")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set Category column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET Category = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with Category {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if subcategory is None:
        print(f'Vulnerability {cve} is missing Subcategory')
        subcategoryQueryString = f"Provide the best fitting VAITP Subcategory from the following list of [VAITP Categories][VAITP Subcategories]: '[Input Validation and Sanitization][Command Injection,SQL Injection,Insecure Direct Object References (IDOR),Path Traversal,Insecure Parsing or Deserialization],[Authentication, Authorization, and Session Management][Weak Password Policies,Insecure Authentication Mechanisms,Session Management Issues,Privilege Escalation],[Cryptographic][Unencrypted communication,Weak encryption algorithm,Inadequate random number generation,Improper SSL/TLS Certificate Validation,Cryptographic Implementation Error],[Design Defects][Inadequate Error Handling,Vulnerable and Outdated Components,Poorly Designed Access Controls,Security Misconfigurations],[Configuration Issues][Cross-Site Scripting (XSS),Cross-Site Request Forgery (CSRF),Remote File Inclusion (RFI),Local File Inclusion (LFI),Open Redirects,Server-Side Request Forgery (SSRF),Dynamic Link Library (DLL) Loading Issues],[Memory Corruption][Buffer Overflows,Out-of-Bound Accesses,Use-After-Free Errors],[Information Leakage][Information Disclosure,Insecure Handling of Sensitive Data],[Race Conditions][Time-of-Check to Time-of-Use,Data Race Conditions in Threads,Race Condition in File Operations],[Resource Management][File Handle Leaks,Socket Handle Leaks,Memory Leaks,Resource Exhaustion],[Numeric Errors][Integer Overflows,Rounding Errors,Floating-Point Precision Issues,Arithmetic Errors]' for the following vulnerability description: '{fullDescription}'. Note that we already selected '{category}' as the main VAITP Category and only want the best fitting Subcategory. Include only the VAITP Subcategory in your answer and nothing else."
        params = {
            "text": subcategoryQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose a VAITP subcategory.")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set Subcategory column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET Subcategory = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with Subcategory {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if impact is None:
        print(f'Vulnerability {cve} is missing Impact')
        impactQueryString = f"Provide the best fitting VAITP Impact Category from the following list 'Information Disclosure,Unauthorized Access,Data Theft,Arbitrary Code Execution,Privilege Escalation,Denial of Service (DoS)' for the following vulnerability description: '{fullDescription}'. In your answer provide only the best fitting VAITP Impact Category for this vulnerability and nothing else."
        params = {
            "text": impactQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose an impact.")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set Impact column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET Impact = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with Impact {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if solution is None:
        print(f'Vulnerability {cve} is missing Solution')
        solutionQueryString = f"Provide the best possible solution for the following vulnerability description '{fullDescription}'. Provide only a very short solution in your answer that includes the version needed to upgrade if there is a patch for the vulnerability, and nothing else."
        params = {
            "text": solutionQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not propose a solution.")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set Solution column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET Solution = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with Solution {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if changeIn is None:
        print(f'Vulnerability {cve} is missing ChangeIn')
        changeInQueryString = f"Name where the change occoured (e.g.: A library name [answer the name of the library] or python [answer 'Python' and the version]) in the following vulnerability description '{fullDescription}'. Include only the name of where the change occoured in your answer and nothing else."
        params = {
            "text": changeInQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not determine where the patch change was made.")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set ChangeIn column to response_value where cvec=%s
                query = "UPDATE python_vulnerabilities SET ChangeIn = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with ChangeIn {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if fixedbyupgrading is None:
        print(f'Vulnerability {cve} is missing fixedbyupgrading')
        fixedbyupgradingQueryString = f"Is the following vulnerability fixed by upgrading to a newer version of Python or a library? '{fullDescription}'. Answer only with the value '0' if the vulnerability can not be fixed by upgrading Python or a library, and the value '1' if the vulnerability can be fixed by upgrading Python or a library to a more recent version. Only answer with '0' or '1', and nothing else."
        params = {
            "text": fixedbyupgradingQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not determine if the vulnerability is fixed by upgrading.")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set fixedbyupgrading column to response_value where cve = %s
                query = "UPDATE python_vulnerabilities SET fixedbyupgrading = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                print(f"VAITP dataset updated {cve} with fixedbyupgrading {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if patchedcodesample is None:
        print(f'Vulnerability {cve} is missing patchedcodesample')
        patchedcodesampleQueryString = f"Provide a Python code that demonstrates how the vulnerability {cve} '{fullDescription}' was fixed. If it is not possible to provide the actual code for the vulnerability fix provide a code example that could represent the vulnerabiltiy as much as possible. Only include in your answer the Python code that fixes the vulnerability and nothing else."
        params = {
            "text": patchedcodesampleQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value:
                print("Blackbox couldn't provide a patched code")
            else:
                response_value = remove_first_and_last_line_if_match(response_value)
                if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                    print("Blackbox AI could not provide a patched code sample")
                else:
                    cnx = mysql.connector.connect(
                        user=os.getenv('MYSQL_USER'),
                        password=os.getenv('MYSQL_PASSWORD'),
                        host=os.getenv('MYSQL_HOST'),
                        database=os.getenv('MYSQL_DATABASE')
                        )
                    # Create a cursor object
                    cursor = cnx.cursor()
                    # Update 'python_vulnerability' table set PatchedCodeSample column to response_value where cve = %s
                    query = "UPDATE python_vulnerabilities SET PatchedCodeSample = %s WHERE CVE = %s"
                    cursor.execute(query, (response_value, cve))
                    cnx.commit()
                    print(f"VAITP dataset updated {cve} with PatchedCodeSample {response_value}")
                    cursor.close
                    cnx.close
                    # Check if there is a file named "../../vaitp_dataset/train/injectable/{id}_1.py"
                    injectablepy = f"../../vaitp_dataset/train/injectable/{id}_1.py"
                    if os.path.exists(injectablepy):
                        print(f"Injectable Python file {injectablepy} exists")
                    else:
                        # Save response_value to ../../vaitp_dataset/train/injectable/{id}_1.py
                        with open(f"../../vaitp_dataset/train/injectable/{id}_1.py", "w") as file:
                            file.write(response_value)
                        print(f"Injectable Python file {injectablepy} created")
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if vulnerablecodesample is None:
            print(f'Vulnerability {cve} is missing vulnerablecodesample')
            vulnerablecodesampleQueryString = f"Provide a Python code that demonstrates how the vulnerability {cve} '{fullDescription}' was before it was fixed. If it is not possible to provide the actual code for the vulnerability provide a code example that could represent the vulnerabiltiy as much as possible. Only include in your answer the Python code before the vulnerability was fixed and nothing else."
            params = {
                "text": vulnerablecodesampleQueryString,
                "conversationId": n
                }
            # Make the GPT request
            response = requests.get(url, params=params)
            # Check the status_code and print the response
            if response.status_code == 200:
                response_value = response.json().get('response')
                print("Blackbox AI Proposed:", response_value)
                if "I'm sorry" in response_value:
                    print("Blackbox couldn't provide a vulnerable code")
                else:
                    response_value = remove_first_and_last_line_if_match(response_value)
                    if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                        print("Blackbox AI could not provide a patched code sample")
                    else:
                        cnx = mysql.connector.connect(
                            user=os.getenv('MYSQL_USER'),
                            password=os.getenv('MYSQL_PASSWORD'),
                            host=os.getenv('MYSQL_HOST'),
                            database=os.getenv('MYSQL_DATABASE')
                            )
                        # Create a cursor object
                        cursor = cnx.cursor()
                        # Update 'python_vulnerability' table set VulnerableCodeSample column to response_value where cve = %s
                        query = "UPDATE python_vulnerabilities SET VulnerableCodeSample = %s WHERE CVE = %s"
                        cursor.execute(query, (response_value, cve))
                        cnx.commit()
                        print(f"VAITP dataset updated {cve} with VulnerableCodeSample {response_value}")
                        cursor.close
                        cnx.close
                        # Check if there is a file named "../../vaitp_dataset/train/noninjectable/{id}_1.py"
                        injectablepy = f"../../vaitp_dataset/train/noninjectable/{id}_1.py"
                        if os.path.exists(injectablepy):
                            print(f"Noninjectable Python file {injectablepy} exists")
                        else:
                            # Save response_value to ../../vaitp_dataset/train/noninjectable/{id}_1.py
                            with open(f"../../vaitp_dataset/train/noninjectable/{id}_1.py", "w") as file:
                                file.write(response_value)
                            print(f"Noninjectable Python file {injectablepy} created")
            else:
                print("Error:", response.status_code, response.text)
            print("Delaying next request...")
            time.sleep(delay)
    if payloadneeded is None:
        print(f'Vulnerability {cve} is missing payloadneeded')
        payloadQueryString = f"Based on the vulnerability description {cve} '{fullDescription}', would a payload be required to exploit this vulnerability? Answer only with '0' if a payload would not be required and with '1' if a payload would be required to exploit, and nothing else."
        params = {
            "text": payloadQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not determine if payload is needed")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set payloadneeded column to response_value where cve
                query = "UPDATE python_vulnerabilities SET payloadneeded = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                payloadneeded = response_value
                print(f"VAITP dataset updated {cve} with payloadneeded {response_value}")
                cursor.close
                cnx.close
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if payloadneeded and payload is None:
        print(f'Vulnerability {cve} is probably missing required payload')
        payloadQueryString = f"Based on the vulnerability description {cve} '{fullDescription}', what would be an example of an appropriate payload to exploit this vulnerability? Only include the payload code in your answer and nothing else."
        params = {
            "text": payloadQueryString,
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            if "I'm sorry" in response_value or "Generated by BLACKBOX.AI, try unlimited chat" in response_value:
                print("Blackbox AI could not provide a payload")
            else:
                cnx = mysql.connector.connect(
                    user=os.getenv('MYSQL_USER'),
                    password=os.getenv('MYSQL_PASSWORD'),
                    host=os.getenv('MYSQL_HOST'),
                    database=os.getenv('MYSQL_DATABASE')
                    )
                # Create a cursor object
                cursor = cnx.cursor()
                # Update 'python_vulnerability' table set payload column to response_value where cve
                query = "UPDATE python_vulnerabilities SET Payload = %s WHERE CVE = %s"
                cursor.execute(query, (response_value, cve))
                cnx.commit()
                payload = response_value
                print(f"VAITP dataset updated {cve} with payload {response_value}")
                cursor.close
                cnx.close
                # Save the payload to ../../vaitp_dataset/payloads/{id}_1.vaitp
                with open(f"../../vaitp_dataset/payloads/{id}_1.vaitp","w") as f:
                    f.write(response_value)
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)
    if isPython is None:
        print(f'Vulnerability {cve} is missing programming language')
        params = {
            "text": f"Based on the vulnerability description {cve} '{fullDescription}', would the vulnerability be coded in Python? Only answer with '0' if the vulnerability would not be coded in Python, and '1' if it would be coded in Python, and nothing else.",
            "conversationId": n
            }
        # Make the GPT request
        response = requests.get(url, params=params)
        # Check the status_code and print the response
        if response.status_code == 200:
            response_value = response.json().get('response')
            print("Blackbox AI Proposed:", response_value)
            cnx = mysql.connector.connect(
                user=os.getenv('MYSQL_USER'),
                password=os.getenv('MYSQL_PASSWORD'),
                host=os.getenv('MYSQL_HOST'),
                database=os.getenv('MYSQL_DATABASE')
                )
            # Create a cursor object
            cursor = cnx.cursor()
            # Update 'python_vulnerability' table set isPython column to response_value where cve = %s
            query = "UPDATE python_vulnerabilities SET isPython = %s WHERE CVE = %s"
            cursor.execute(query, (response_value, cve))
            cnx.commit()
            cursor.close()
            cnx.close
            print(f"VAITP dataset updated {cve} with isPython {response_value}")
        else:
            print("Error:", response.status_code, response.text)
        print("Delaying next request...")
        time.sleep(delay)

print("VAITP info agent finnished to review and propose missing data.")


